{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/routing-decision.schema.json",
  "title": "RoutingDecision",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "request_id",
    "created_at",
    "input",
    "extraction",
    "understanding",
    "routing",
    "compliance",
    "diagnostics"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "request_id": {
      "type": "string",
      "minLength": 1
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "input": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "source_channel",
        "file",
        "metadata"
      ],
      "properties": {
        "document_id": {
          "type": "string"
        },
        "source_channel": {
          "type": "string",
          "enum": [
            "email",
            "edms",
            "manual_upload"
          ]
        },
        "file": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "filename",
            "pages"
          ],
          "properties": {
            "filename": {
              "type": "string",
              "minLength": 1
            },
            "sha256": {
              "type": "string",
              "pattern": "^[A-Fa-f0-9]{64}$"
            },
            "pages": {
              "type": "integer",
              "minimum": 1
            }
          }
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "properties": {
            "email_subject": {
              "type": "string"
            },
            "sender": {
              "type": "string"
            },
            "received_at": {
              "type": "string",
              "format": "date-time"
            }
          }
        }
      }
    },
    "extraction": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "text_source",
        "language",
        "page_map",
        "quality"
      ],
      "properties": {
        "text_source": {
          "type": "string",
          "enum": [
            "native",
            "ocr",
            "mixed"
          ]
        },
        "language": {
          "type": "string",
          "minLength": 2,
          "maxLength": 8
        },
        "page_map": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "page",
              "text_span_id",
              "char_start",
              "char_end"
            ],
            "properties": {
              "page": {
                "type": "integer",
                "minimum": 1
              },
              "text_span_id": {
                "type": "string",
                "minLength": 1
              },
              "char_start": {
                "type": "integer",
                "minimum": 0
              },
              "char_end": {
                "type": "integer",
                "minimum": 0
              }
            }
          }
        },
        "quality": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "ocr_confidence",
            "has_tables",
            "has_stamps_signatures",
            "warnings"
          ],
          "properties": {
            "ocr_confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "has_tables": {
              "type": "boolean"
            },
            "has_stamps_signatures": {
              "type": "string",
              "enum": [
                "unknown",
                "yes",
                "no"
              ]
            },
            "warnings": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "understanding": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "doc_type",
        "summary",
        "topics",
        "urgency",
        "entities"
      ],
      "properties": {
        "doc_type": {
          "type": "string",
          "minLength": 1
        },
        "summary": {
          "type": "string",
          "minLength": 1
        },
        "topics": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "urgency": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "level",
            "signals"
          ],
          "properties": {
            "level": {
              "type": "string",
              "enum": [
                "low",
                "normal",
                "high"
              ]
            },
            "deadline_date": {
              "type": "string",
              "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
            },
            "signals": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "entities": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "organizations",
            "people",
            "numbers",
            "dates",
            "amounts",
            "locations"
          ],
          "properties": {
            "organizations": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "name",
                  "role"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "minLength": 1
                  },
                  "role": {
                    "type": "string",
                    "enum": [
                      "sender",
                      "mentioned"
                    ]
                  }
                }
              }
            },
            "people": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "name",
                  "role"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "minLength": 1
                  },
                  "role": {
                    "type": "string",
                    "enum": [
                      "signatory",
                      "mentioned"
                    ]
                  }
                }
              }
            },
            "numbers": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "contract_numbers",
                "invoice_numbers",
                "letter_numbers",
                "law_refs"
              ],
              "properties": {
                "contract_numbers": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "invoice_numbers": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "letter_numbers": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "law_refs": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            },
            "dates": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "value",
                  "label"
                ],
                "properties": {
                  "value": {
                    "type": "string",
                    "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
                  },
                  "label": {
                    "type": "string"
                  }
                }
              }
            },
            "amounts": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "value",
                  "currency",
                  "label"
                ],
                "properties": {
                  "value": {
                    "type": "number"
                  },
                  "currency": {
                    "type": "string",
                    "minLength": 3,
                    "maxLength": 3
                  },
                  "label": {
                    "type": "string"
                  }
                }
              }
            },
            "locations": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "name",
                  "role"
                ],
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "role": {
                    "type": "string"
                  }
                }
              }
            }
          }
        }
      }
    },
    "routing": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "mode",
        "suggestions",
        "final_recommendation",
        "needs_human_review",
        "review_reasons"
      ],
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "suggest_only",
            "auto_route_allowed"
          ]
        },
        "suggestions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "department_id",
              "department_name",
              "confidence",
              "priority",
              "why",
              "matched_signals",
              "evidence",
              "next_actions"
            ],
            "properties": {
              "department_id": {
                "type": "string",
                "minLength": 1
              },
              "department_name": {
                "type": "string",
                "minLength": 1
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "priority": {
                "type": "string",
                "enum": [
                  "primary",
                  "coexecutor",
                  "cc"
                ]
              },
              "why": {
                "type": "string",
                "minLength": 1
              },
              "matched_signals": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "keywords",
                  "rules_triggered",
                  "semantic_score"
                ],
                "properties": {
                  "keywords": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "rules_triggered": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "semantic_score": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1
                  }
                }
              },
              "evidence": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": [
                    "page",
                    "quote",
                    "char_start",
                    "char_end"
                  ],
                  "properties": {
                    "page": {
                      "type": "integer",
                      "minimum": 1
                    },
                    "quote": {
                      "type": "string",
                      "minLength": 1,
                      "maxLength": 500
                    },
                    "char_start": {
                      "type": "integer",
                      "minimum": 0
                    },
                    "char_end": {
                      "type": "integer",
                      "minimum": 0
                    }
                  }
                }
              },
              "next_actions": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "handoff": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "queue": {
                    "type": "string"
                  },
                  "assignee_role": {
                    "type": "string"
                  },
                  "sla_hours": {
                    "type": "integer",
                    "minimum": 1
                  }
                }
              }
            }
          }
        },
        "final_recommendation": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "department_ids",
            "confidence",
            "comment"
          ],
          "properties": {
            "department_ids": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string"
              }
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "comment": {
              "type": "string"
            }
          }
        },
        "needs_human_review": {
          "type": "boolean"
        },
        "review_reasons": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "compliance": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "sensitive_flags",
        "safe_to_log_text",
        "masking"
      ],
      "properties": {
        "sensitive_flags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "safe_to_log_text": {
          "type": "string",
          "enum": [
            "masked",
            "no",
            "yes"
          ]
        },
        "masking": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "enabled",
            "masked_fields"
          ],
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "masked_fields": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "diagnostics": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "processing_time_ms",
        "model",
        "trace",
        "errors",
        "warnings"
      ],
      "properties": {
        "processing_time_ms": {
          "type": "integer",
          "minimum": 0
        },
        "model": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "name",
            "version"
          ],
          "properties": {
            "name": {
              "type": "string"
            },
            "version": {
              "type": "string"
            }
          }
        },
        "trace": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "rules_version",
            "catalog_version"
          ],
          "properties": {
            "rules_version": {
              "type": "string"
            },
            "catalog_version": {
              "type": "string"
            }
          }
        },
        "errors": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}